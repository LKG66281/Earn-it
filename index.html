<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Login System</title>
    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, deleteUser, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDptrY_22JlFegSAzXU52Wg8Wu6TUXqqjI",
            authDomain: "earn-it-7d72d.firebaseapp.com",
            projectId: "earn-it-7d72d",
            storageBucket: "earn-it-7d72d.firebasestorage.app",
            messagingSenderId: "1756161084",
            appId: "1:1756161084:web:3db1e0d934ac844ed28f39",
            measurementId: "G-J98NDHW03J"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore();

        // Signup Function
        async function signup() {
            let email = document.getElementById("email").value;
            let password = document.getElementById("password").value;

            if (!email || !password) {
                alert("Please fill all fields!");
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Save user data in Firestore
                await setDoc(doc(db, "users", user.uid), {
                    email: email,
                    username: email.split("@")[0] // Default username
                });

                alert("Signup successful! Now you can login.");
                location.reload();
            } catch (error) {
                alert(error.message);
            }
        }

        // Login Function
        async function login() {
            let email = document.getElementById("loginEmail").value;
            let password = document.getElementById("loginPassword").value;

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                loadDashboard(user.uid);
            } catch (error) {
                alert("Invalid credentials!");
            }
        }

        // Load Dashboard Data
        async function loadDashboard(userId) {
            const userDoc = await getDoc(doc(db, "users", userId));

            if (userDoc.exists()) {
                document.getElementById("authForm").style.display = "none";
                document.getElementById("dashboard").style.display = "block";
                document.getElementById("username").innerText = userDoc.data().username;
            }
        }

        // Change Username
        async function changeUsername() {
            let newUsername = document.getElementById("newUsername").value;
            let user = auth.currentUser;

            if (user) {
                await updateDoc(doc(db, "users", user.uid), {
                    username: newUsername
                });
                alert("Username updated!");
                loadDashboard(user.uid);
            }
        }

        // Delete Account
        async function deleteAccount() {
            let user = auth.currentUser;

            if (user) {
                await deleteDoc(doc(db, "users", user.uid));
                await deleteUser(user);
                alert("Account deleted!");
                location.reload();
            }
        }

        // Logout Function
        function logout() {
            signOut(auth).then(() => {
                alert("Logged out!");
                location.reload();
            });
        }

        // Check Auth State
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loadDashboard(user.uid);
            }
        });

        // Show Login Form
        function showLogin() {
            document.getElementById("pageTitle").innerText = "Login";
            document.getElementById("authForm").innerHTML = `
                <input type="email" id="loginEmail" placeholder="Enter Email"><br>
                <input type="password" id="loginPassword" placeholder="Enter Password"><br>
                <button onclick="login()">Login</button>
                <p>Don't have an account? <a href="#" onclick="location.reload()">Signup</a></p>
            `;
        }
    </script>
</head>
<body>
    <h2 id="pageTitle">Signup</h2>

    <div id="authForm">
        <input type="email" id="email" placeholder="Enter Email"><br>
        <input type="password" id="password" placeholder="Enter Password"><br>
        <button onclick="signup()">Signup</button>
        <p>Already have an account? <a href="#" onclick="showLogin()">Login</a></p>
    </div>

    <div id="dashboard" style="display: none;">
        <h2>Welcome, <span id="username"></span>!</h2>
        <input type="text" id="newUsername" placeholder="Enter New Username">
        <button onclick="changeUsername()">Change Username</button>
        <button onclick="deleteAccount()">Delete Account</button>
        <button onclick="logout()">Logout</button>
    </div>
</body>
</html>
